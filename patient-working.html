<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - DeLas Alas Dental Clinic</title>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px;
        }

        .sidebar h2 {
            color: #ffd700;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #34495e;
            border-radius: 10px;
        }

        .user-info h3 {
            margin-bottom: 10px;
        }

        .user-info p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: #6c757d;
            text-decoration: none;
            border-radius: 12px;
            margin: 0.25rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-item a:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-item a:hover,
        .nav-item a.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: #667eea;
            transform: translateX(4px);
        }

        .nav-item a:hover:before,
        .nav-item a.active:before {
            transform: scaleY(1);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            margin-top: 1rem;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #ee5a52 0%, #e74c3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Enhanced Button Styles - Matching Dentist Dashboard */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 5px;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid transparent;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: 2px solid transparent;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: 2px solid transparent;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: 2px solid transparent;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 6px;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2c3e50;
            margin: 0.5rem 0;
            transition: color 0.3s ease;
        }

        .stat-card:hover .stat-number {
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .qr-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        .qr-container {
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-placeholder {
            color: #667eea;
        }

        .qr-placeholder i {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 1.5rem;
            border-radius: 16px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 2px solid #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #6c757d;
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: #f8f9fa;
            color: #495057;
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Responsive form layout */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1% auto;
                padding: 1rem;
                width: 98%;
                max-height: 95vh;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-group label {
                font-size: 0.9rem;
            }
        }

        @media (min-width: 1200px) {
            .modal-content {
                max-width: 800px;
            }
        }

        /* Patient Calendar Widget Styles */
        .date-picker-container {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
        }

        .calendar-widget {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .calendar-widget-header {
            background: #667eea;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border-radius: 4px;
        }

        .calendar-widget-day {
            background: white;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 4px;
            font-size: 12px;
            position: relative;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .calendar-widget-day:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .calendar-widget-day.today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-widget-day.today:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .calendar-widget-day.other-month {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .calendar-widget-day.other-month:hover {
            background: #f8f9fa;
            transform: none;
        }

        .calendar-widget-day.past-date {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .calendar-widget-day.past-date:hover {
            background: #f8f9fa;
            transform: none;
        }

        .calendar-widget-day.selected {
            background: #28a745;
            color: white;
        }

        .calendar-widget-day.selected:hover {
            background: #218838;
        }

        .availability-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            font-weight: bold;
        }

        .availability-indicator.available {
            color: #28a745;
        }

        .availability-indicator.unavailable {
            color: #dc3545;
        }

        .availability-info {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .availability-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        .availability-item .availability-indicator {
            position: static;
            font-size: 14px;
        }

        .slot-count {
            font-size: 8px;
            font-weight: bold;
            margin-top: 2px;
            color: #6c757d;
            line-height: 1;
        }

        .calendar-widget-day.today .slot-count {
            color: rgba(255,255,255,0.8);
        }

        .calendar-widget-day.selected .slot-count {
            color: rgba(255,255,255,0.8);
        }

        /* Dynamic Button States */
        .btn:disabled {
            background: #6c757d;
            color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }

        .btn:disabled:hover {
            background: #6c757d;
            transform: none;
        }

        .btn.btn-ready {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            animation: pulse-green 2s infinite;
        }

        .btn.btn-ready:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .form-validation-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
        }

        .form-validation-status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .form-validation-status.not-ready {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .info-box p {
            margin: 5px 0;
            color: #1976d2;
        }

        .info-box i {
            color: #2196f3;
            margin-right: 8px;
        }

        .btn-ready {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        .btn-ready:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }


        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #27ae60;
        }

        .toast.error {
            border-left: 4px solid #e74c3c;
        }

        .toast.info {
            border-left: 4px solid #3498db;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .appointment-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            margin: 10px 0;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .appointment-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #27ae60, #20c997);
        }

        .appointment-card:hover {
            transform: translateY(-4px);
            border-color: #27ae60;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.15);
        }

        .appointment-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .appointment-card p {
            color: #666;
            margin-bottom: 5px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .action-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .action-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
        }

        .action-card i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .action-card:hover i {
            transform: scale(1.1);
            color: #764ba2;
        }

        .action-card h3 {
            color: #2c3e50;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }

        .action-card:hover h3 {
            color: #667eea;
        }

        .action-card p {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0;
            transition: color 0.3s ease;
        }

        .action-card:hover p {
            color: #495057;
        }

        .treatment-cards, .payment-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .treatment-card, .payment-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .treatment-card:before, .payment-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .treatment-card:hover, .payment-card:hover {
            transform: translateY(-6px);
            border-color: #667eea;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.15);
        }

        .treatment-card h4, .payment-card h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .treatment-card p, .payment-card p {
            color: #666;
            margin-bottom: 8px;
        }

        .payment-summary {
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .summary-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #27ae60, #20c997);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            border-color: #27ae60;
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.15);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .stat-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .settings-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .settings-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .settings-card:hover {
            transform: translateY(-4px);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .settings-card h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item label {
            font-weight: bold;
            color: #666;
            min-width: 120px;
        }

        .setting-item span {
            color: #333;
            flex: 1;
            margin: 0 10px;
        }

        .setting-item select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .appointment-header h3 {
            color: #333;
            margin: 0;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .status.confirmed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .status.pending {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        .status.cancelled {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .appointment-details {
            margin-bottom: 20px;
        }

        .appointment-details p {
            margin-bottom: 8px;
            color: #666;
        }

        .appointment-actions {
            display: flex;
            gap: 10px;
        }

        .upcoming-appointments {
            margin-top: 30px;
        }

        .upcoming-appointments h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .appointment-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .appointment-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .appointment-item:hover {
            transform: translateY(-4px);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .appointment-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .appointment-info p {
            color: #666;
            margin-bottom: 3px;
            font-size: 14px;
        }

        .appointment-status {
            text-align: right;
        }

        .appointment-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .history-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .history-item:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
        }

        .history-info h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .history-info p {
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Delas Alas Dental Clinic</h2>
            
            <div class="user-info">
                <h3 id="userName">Juan Dela Cruz</h3>
                <p id="userEmail">juan.delacruz@email.com</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" onclick="showSection('dashboard')" class="active">
                        üìä Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="showSection('appointments')">
                        üìÖ My Appointments
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="showSection('qr-code')">
                        üî≤ My QR Code
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="showSection('treatments')">
                        ü¶∑ Treatments
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="showSection('payments')">
                        üí≥ Payments
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="showSection('settings')">
                        ‚öôÔ∏è Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" onclick="logout()" class="logout-btn">
                        üö™ Logout
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Patient Dashboard</h1>
                <p>Welcome back! Manage your dental appointments and health records.</p>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="content">
                    <h2>Dashboard Overview</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card" onclick="showSection('appointments')">
                            <div class="stat-number">8</div>
                            <div class="stat-label">Total Appointments</div>
                        </div>
                        <div class="stat-card" onclick="showSection('treatments')">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Treatments Done</div>
                        </div>
                        <div class="stat-card" onclick="showSection('payments')">
                            <div class="stat-number">‚Ç±15,500</div>
                            <div class="stat-label">Total Payments</div>
                        </div>
                        <div class="stat-card" onclick="showSection('settings')">
                            <div class="stat-number">5</div>
                            <div class="stat-label">Medical Records</div>
                        </div>
                    </div>

                    <div class="qr-section">
                        <h3>üî≤ Your Appointment QR Code</h3>
                        <div class="qr-container" id="qrContainer">
                            <div class="qr-placeholder">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚è≥</div>
                                <h3>Loading QR Code...</h3>
                                <p>Your appointment QR code is being generated automatically</p>
                            </div>
                        </div>
                        <button class="btn" onclick="generateQRCode()">
                            üîÑ Refresh QR Code
                        </button>
                        <button class="btn btn-secondary" onclick="showFallbackQRCode()">
                            üìã Show QR Info
                        </button>
                    </div>

                    <div class="quick-actions">
                        <div class="action-card" onclick="showSection('appointments')">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìÖ</div>
                            <h3>View Appointments</h3>
                            <p>Check your upcoming and past appointments</p>
                        </div>
                        <div class="action-card" onclick="showSection('qr-code')">
                            <div style="font-size: 2em; margin-bottom: 10px;">üî≤</div>
                            <h3>My QR Code</h3>
                            <p>Generate and manage your QR codes</p>
                        </div>
                        <div class="action-card" onclick="showSection('payments')">
                            <div style="font-size: 2em; margin-bottom: 10px;">üí≥</div>
                            <h3>View Payments</h3>
                            <p>Check your payment history and bills</p>
                        </div>
                        <div class="action-card" onclick="openEditProfile()">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚úèÔ∏è</div>
                            <h3>Edit Profile</h3>
                            <p>Update your personal information</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Section -->
            <div id="appointments" class="section">
                <div class="content">
                    <h2>My Appointments</h2>
                    <p>View and manage your upcoming dental appointments.</p>
                    
                    <div class="appointment-card">
                        <div class="appointment-header">
                            <h3>ü¶∑ Next Appointment</h3>
                            <span class="status confirmed">Confirmed</span>
                        </div>
                        <div class="appointment-details">
                            <p><strong>Date:</strong> March 25, 2025</p>
                            <p><strong>Time:</strong> 10:00 AM</p>
                            <p><strong>Dentist:</strong> Dr. Maria Santos</p>
                            <p><strong>Service:</strong> Dental Cleaning</p>
                            <p><strong>Room:</strong> Room 2</p>
                        </div>
                        <div class="appointment-actions">
                            <button class="btn btn-secondary" onclick="rescheduleAppointment()">
                                üìÖ Reschedule
                            </button>
                            <button class="btn btn-danger" onclick="cancelAppointment()">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>

                    <div class="upcoming-appointments">
                        <h3>üìÖ Upcoming Appointments</h3>
                        <div class="appointment-list" id="appointmentList">
                            <div class="appointment-item">
                                <div class="appointment-info">
                                    <h4>Dental Checkup</h4>
                                    <p>April 5, 2025 at 2:00 PM</p>
                                    <p>Dr. John Smith</p>
                                </div>
                                <div class="appointment-status">
                                    <span class="status pending">Pending</span>
                                </div>
                            </div>
                            <div class="appointment-item">
                                <div class="appointment-info">
                                    <h4>Teeth Whitening</h4>
                                    <p>April 15, 2025 at 11:00 AM</p>
                                    <p>Dr. Maria Santos</p>
                                </div>
                                <div class="appointment-status">
                                    <span class="status confirmed">Confirmed</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="bookNewAppointment()">
                            ‚ûï Book New Appointment
                        </button>
                        <button class="btn btn-secondary" onclick="viewAppointmentHistory()">
                            üìã View History
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR Code Section -->
            <div id="qr-code" class="section">
                <div class="content">
                    <h2>My QR Code</h2>
                    
                    <div class="qr-section">
                        <h3>üî≤ Your Appointment QR Code</h3>
                        <div class="qr-container" id="qrContainer2">
                            <div class="qr-placeholder">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚è≥</div>
                                <h3>Loading QR Code...</h3>
                                <p>Your appointment QR code is being generated automatically</p>
                            </div>
                        </div>
                        <button class="btn" onclick="generateQRCode()">
                            üîÑ Refresh QR Code
                        </button>
                        <button class="btn btn-secondary" onclick="downloadQRCode()">
                            üíæ Download QR Code
                        </button>
                        <button class="btn btn-secondary" onclick="printQRCode()">
                            üñ®Ô∏è Print QR Code
                        </button>
                    </div>
                </div>
            </div>

            <!-- Treatments Section -->
            <div id="treatments" class="section">
                <div class="content">
                    <h2>My Treatments</h2>
                    <p>View your dental treatment history and procedures.</p>
                    
                    <div class="treatment-cards">
                        <div class="treatment-card">
                            <h4>ü¶∑ Dental Cleaning</h4>
                            <p><strong>Date:</strong> March 15, 2025</p>
                            <p><strong>Dentist:</strong> Dr. Maria Santos</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            <p><strong>Cost:</strong> ‚Ç±2,500</p>
                            <button class="btn btn-secondary" onclick="viewTreatmentDetails('cleaning')">
                                üìã View Details
                            </button>
                        </div>

                        <div class="treatment-card">
                            <h4>ü¶∑ Teeth Whitening</h4>
                            <p><strong>Date:</strong> March 10, 2025</p>
                            <p><strong>Dentist:</strong> Dr. John Smith</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            <p><strong>Cost:</strong> ‚Ç±8,000</p>
                            <button class="btn btn-secondary" onclick="viewTreatmentDetails('whitening')">
                                üìã View Details
                            </button>
                        </div>

                        <div class="treatment-card">
                            <h4>ü¶∑ Tooth Extraction</h4>
                            <p><strong>Date:</strong> March 5, 2025</p>
                            <p><strong>Dentist:</strong> Dr. Maria Santos</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            <p><strong>Cost:</strong> ‚Ç±3,500</p>
                            <button class="btn btn-secondary" onclick="viewTreatmentDetails('extraction')">
                                üìã View Details
                            </button>
                        </div>

                        <div class="treatment-card">
                            <h4>ü¶∑ Dental Checkup</h4>
                            <p><strong>Date:</strong> March 1, 2025</p>
                            <p><strong>Dentist:</strong> Dr. John Smith</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            <p><strong>Cost:</strong> ‚Ç±1,500</p>
                            <button class="btn btn-secondary" onclick="viewTreatmentDetails('checkup')">
                                üìã View Details
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="bookNewTreatment()">
                            ‚ûï Book New Treatment
                        </button>
                        <button class="btn btn-secondary" onclick="downloadTreatmentHistory()">
                            üì• Download History
                        </button>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments" class="section">
                <div class="content">
                    <h2>My Payments</h2>
                    <p>View your payment history and outstanding bills.</p>
                    
                    <div class="payment-summary">
                        <div class="summary-card">
                            <h3>üí∞ Payment Summary</h3>
                            <div class="summary-stats">
                                <div class="stat">
                                    <span class="stat-label">Total Paid:</span>
                                    <span class="stat-value" style="color: #27ae60;">‚Ç±15,500</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Outstanding:</span>
                                    <span class="stat-value" style="color: #e74c3c;">‚Ç±0</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Next Due:</span>
                                    <span class="stat-value">No pending payments</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-cards">
                        <div class="payment-card">
                            <h4>üí≥ Payment #001</h4>
                            <p><strong>Date:</strong> March 15, 2025</p>
                            <p><strong>Amount:</strong> ‚Ç±2,500</p>
                            <p><strong>Method:</strong> Credit Card</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Paid</span></p>
                            <p><strong>Service:</strong> Dental Cleaning</p>
                            <button class="btn btn-secondary" onclick="viewPaymentDetails('001')">
                                üìã View Receipt
                            </button>
                        </div>

                        <div class="payment-card">
                            <h4>üí≥ Payment #002</h4>
                            <p><strong>Date:</strong> March 10, 2025</p>
                            <p><strong>Amount:</strong> ‚Ç±8,000</p>
                            <p><strong>Method:</strong> Bank Transfer</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Paid</span></p>
                            <p><strong>Service:</strong> Teeth Whitening</p>
                            <button class="btn btn-secondary" onclick="viewPaymentDetails('002')">
                                üìã View Receipt
                            </button>
                        </div>

                        <div class="payment-card">
                            <h4>üí≥ Payment #003</h4>
                            <p><strong>Date:</strong> March 5, 2025</p>
                            <p><strong>Amount:</strong> ‚Ç±3,500</p>
                            <p><strong>Method:</strong> Cash</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Paid</span></p>
                            <p><strong>Service:</strong> Tooth Extraction</p>
                            <button class="btn btn-secondary" onclick="viewPaymentDetails('003')">
                                üìã View Receipt
                            </button>
                        </div>

                        <div class="payment-card">
                            <h4>üí≥ Payment #004</h4>
                            <p><strong>Date:</strong> March 1, 2025</p>
                            <p><strong>Amount:</strong> ‚Ç±1,500</p>
                            <p><strong>Method:</strong> Credit Card</p>
                            <p><strong>Status:</strong> <span style="color: #27ae60;">Paid</span></p>
                            <p><strong>Service:</strong> Dental Checkup</p>
                            <button class="btn btn-secondary" onclick="viewPaymentDetails('004')">
                                üìã View Receipt
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="makePayment()">
                            üí≥ Make Payment
                        </button>
                        <button class="btn btn-secondary" onclick="downloadPaymentHistory()">
                            üì• Download History
                        </button>
                        <button class="btn btn-secondary" onclick="viewBillingInfo()">
                            üìÑ Billing Information
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="content">
                    <h2>Settings</h2>
                    <p>Manage your account settings and preferences.</p>
                    
                    <div class="settings-grid">
                        <div class="settings-card">
                            <h3>üë§ Profile Settings</h3>
                            <div class="setting-item">
                                <label>Full Name:</label>
                                <span>Juan Dela Cruz</span>
                                <button class="btn btn-secondary" onclick="openEditProfile()">Edit</button>
                            </div>
                            <div class="setting-item">
                                <label>Email:</label>
                                <span>juan.delacruz@email.com</span>
                                <button class="btn btn-secondary" onclick="changeEmail()">Change</button>
                            </div>
                            <div class="setting-item">
                                <label>Phone:</label>
                                <span>+63 912 345 6789</span>
                                <button class="btn btn-secondary" onclick="changePhone()">Change</button>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>üîî Notifications</h3>
                            <div class="setting-item">
                                <label>Email Notifications:</label>
                                <input type="checkbox" checked> Enabled
                            </div>
                            <div class="setting-item">
                                <label>SMS Notifications:</label>
                                <input type="checkbox" checked> Enabled
                            </div>
                            <div class="setting-item">
                                <label>Appointment Reminders:</label>
                                <input type="checkbox" checked> Enabled
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>üîí Security</h3>
                            <div class="setting-item">
                                <label>Password:</label>
                                <span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                                <button class="btn btn-secondary" onclick="changePassword()">Change</button>
                            </div>
                            <div class="setting-item">
                                <label>Two-Factor Auth:</label>
                                <span style="color: #e74c3c;">Disabled</span>
                                <button class="btn btn-secondary" onclick="enable2FA()">Enable</button>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3>‚öôÔ∏è Preferences</h3>
                            <div class="setting-item">
                                <label>Language:</label>
                                <select>
                                    <option>English</option>
                                    <option>Filipino</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>Time Zone:</label>
                                <select>
                                    <option>Asia/Manila (GMT+8)</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>Theme:</label>
                                <select>
                                    <option>Light</option>
                                    <option>Dark</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="saveSettings()">
                            üíæ Save Settings
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            üì§ Export Data
                        </button>
                        <button class="btn btn-secondary" onclick="deleteAccount()">
                            üóëÔ∏è Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditProfile()">&times;</span>
            <h2>Edit Profile</h2>
            <form id="editProfileForm">
                <div class="form-group">
                    <label for="editFullName">Full Name</label>
                    <input type="text" id="editFullName" value="Juan Dela Cruz">
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" value="juan.delacruz@email.com">
                </div>
                <div class="form-group">
                    <label for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" value="+63 912 345 6789">
                </div>
                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress">123 Main Street, Manila, Philippines</textarea>
                </div>
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditProfile()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQRModal()">&times;</span>
            <h2>Your Appointment QR Code</h2>
            <div id="qrCodeDisplay" style="text-align: center; padding: 20px;">
                <!-- QR Code will be generated here -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="downloadQRCode()">
                    üíæ Download QR Code
                </button>
                <button class="btn btn-secondary" onclick="printQRCode()">
                    üñ®Ô∏è Print QR Code
                </button>
            </div>
        </div>
    </div>

    <script>
        // Show specific section
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update navigation
            const navItems = document.querySelectorAll('.nav-item a');
            navItems.forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item
            event.target.classList.add('active');

            showToast('Switched to ' + sectionName, 'info');
        }

        // Generate QR Code (using same format as Excel template)
        function generateQRCode() {
            // Create appointment data matching Excel template format
            const appointmentData = {
                patientId: "P001",
                name: "Juan Dela Cruz",
                phone: "+63 912 345 6789",
                email: "juan.delacruz@email.com",
                date: "2025-03-25",
                time: "10:00 AM",
                dentist: "Dr. Maria Santos",
                service: "Dental Cleaning",
                room: "Room 2",
                status: "Confirmed",
                qrCode: "QR001",
                clinic: "DeLas Alas Dental Clinic"
            };

            // Generate QR code URL using same format as Excel template
            const qrData = `${appointmentData.patientId}-${appointmentData.name}-${appointmentData.date}-${appointmentData.time}-${appointmentData.dentist}-${appointmentData.service}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;

            // Clear previous QR code containers
            document.getElementById('qrContainer').innerHTML = '';
            document.getElementById('qrContainer2').innerHTML = '';
            document.getElementById('qrCodeDisplay').innerHTML = '';

            // Update all QR containers with real QR code from API
            updateQRContainersWithImage(qrUrl, appointmentData);

            // Show QR code modal
            document.getElementById('qrCodeModal').style.display = 'block';
            showToast('QR Code updated successfully!', 'success');
        }

        function generateQRCodePattern(data) {
            // Generate consistent QR code pattern based on data (same as dentist dashboard)
            const hash = data.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            
            // Create consistent pattern based on hash
            const pattern = [];
            for (let i = 0; i < 100; i++) {
                const shouldFill = ((hash + i) % 3) === 0;
                pattern.push(shouldFill ? '#000' : '#fff');
            }
            
            return pattern.map(color => `<div style="background: ${color};"></div>`).join('');
        }

        function updateQRContainers(qrCode, appointmentData) {
            const qrText = `
                PATIENT: ${appointmentData.patient}
                PATIENT ID: ${appointmentData.patientId}
                QR CODE: ${appointmentData.qrCode}
                DATE: ${appointmentData.date}
                TIME: ${appointmentData.time}
                DENTIST: ${appointmentData.dentist}
                SERVICE: ${appointmentData.service}
                STATUS: ${appointmentData.status}
                CLINIC: ${appointmentData.clinic}
            `;

            const qrContainerHTML = `
                <div style="text-align: center; background: white; padding: 20px; border: 2px solid #667eea; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üî≤ Your QR Code</h3>
                    <div class="qr-code" style="width: 200px; height: 200px; border: 2px solid #333; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); margin: 20px auto;">
                        ${qrCode}
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 11px; text-align: left; max-width: 300px; margin: 10px auto;">
                        <pre style="margin: 0; line-height: 1.3;">${qrText}</pre>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 15px;">
                        Show this at the clinic for quick check-in
                    </p>
                </div>
            `;

            document.getElementById('qrContainer').innerHTML = qrContainerHTML;
            document.getElementById('qrContainer2').innerHTML = qrContainerHTML;
            document.getElementById('qrCodeDisplay').innerHTML = qrContainerHTML;
        }

        function updateQRContainersWithImage(qrUrl, appointmentData) {
            const qrText = `
                PATIENT: ${appointmentData.name}
                PATIENT ID: ${appointmentData.patientId}
                QR CODE: ${appointmentData.qrCode}
                DATE: ${appointmentData.date}
                TIME: ${appointmentData.time}
                DENTIST: ${appointmentData.dentist}
                SERVICE: ${appointmentData.service}
                ROOM: ${appointmentData.room}
                STATUS: ${appointmentData.status}
                CLINIC: ${appointmentData.clinic}
            `;

            const qrContainerHTML = `
                <div style="text-align: center; background: white; padding: 20px; border: 2px solid #667eea; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üî≤ Your QR Code</h3>
                    <img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px; border: 2px solid #333; margin: 20px auto; display: block;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 11px; text-align: left; max-width: 300px; margin: 10px auto;">
                        <pre style="margin: 0; line-height: 1.3;">${qrText}</pre>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 15px;">
                        Show this at the clinic for quick check-in
                    </p>
                </div>
            `;

            document.getElementById('qrContainer').innerHTML = qrContainerHTML;
            document.getElementById('qrContainer2').innerHTML = qrContainerHTML;
            document.getElementById('qrCodeDisplay').innerHTML = qrContainerHTML;
        }

        // Fallback QR Code function (when library doesn't load) - now uses Excel template format
        function showFallbackQRCode() {
            // Use same appointment data format as Excel template
            const appointmentData = {
                patientId: "P001",
                name: "Juan Dela Cruz",
                phone: "+63 912 345 6789",
                email: "juan.delacruz@email.com",
                date: "2025-03-25",
                time: "10:00 AM",
                dentist: "Dr. Maria Santos",
                service: "Dental Cleaning",
                room: "Room 2",
                status: "Confirmed",
                qrCode: "QR001",
                clinic: "DeLas Alas Dental Clinic"
            };

            // Generate QR code URL using same format as Excel template
            const qrData = `${appointmentData.patientId}-${appointmentData.name}-${appointmentData.date}-${appointmentData.time}-${appointmentData.dentist}-${appointmentData.service}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;

            // Update all QR containers with real QR code from API
            updateQRContainersWithImage(qrUrl, appointmentData);
            
            showToast('QR Code generated successfully!', 'success');
        }

        // Create a simple QR code pattern
        function createSimpleQRPattern() {
            const size = 12;
            let pattern = '<div style="display: inline-block; font-family: monospace; line-height: 1; font-size: 8px;">';
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    // Create a simple pattern that looks like a QR code
                    const isBlack = (i + j) % 3 === 0 || (i * j) % 7 === 0 || (i === 0 || i === size-1 || j === 0 || j === size-1);
                    const color = isBlack ? '#000' : '#fff';
                    pattern += `<span style="display: inline-block; width: 8px; height: 8px; background: ${color}; border: 1px solid #ddd;"></span>`;
                }
                pattern += '<br>';
            }
            pattern += '</div>';
            return pattern;
        }

        // Download QR Code
        function downloadQRCode() {
            const canvas = document.getElementById('qrCanvas3');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'appointment-qr-code.png';
                link.href = canvas.toDataURL();
                link.click();
                showToast('QR Code downloaded!', 'success');
            } else {
                showToast('Please generate QR code first!', 'error');
            }
        }

        // Print QR Code
        function printQRCode() {
            const canvas = document.getElementById('qrCanvas3');
            if (canvas) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Appointment QR Code</title>
                            <style>
                                body { 
                                    text-align: center; 
                                    padding: 20px; 
                                    font-family: Arial, sans-serif;
                                }
                                h1 { color: #667eea; }
                                .qr-container {
                                    background: white;
                                    padding: 30px;
                                    border: 2px solid #667eea;
                                    border-radius: 10px;
                                    display: inline-block;
                                    margin: 20px 0;
                                }
                            </style>
                        </head>
                        <body>
                            <h1>Your Appointment QR Code</h1>
                            <div class="qr-container">
                                <h3 style="color: #667eea; margin-bottom: 20px;">üî≤ APPOINTMENT QR CODE</h3>
                                <img src="${canvas.toDataURL()}" style="max-width: 300px;">
                                <p style="color: #666; font-size: 14px; margin-top: 20px;">
                                    Show this QR code at the clinic for quick check-in
                                </p>
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            } else {
                showToast('Please generate QR code first!', 'error');
            }
        }

        // Close QR Modal
        function closeQRModal() {
            document.getElementById('qrCodeModal').style.display = 'none';
        }

        // Open Edit Profile
        function openEditProfile() {
            document.getElementById('editProfileModal').style.display = 'block';
        }

        // Close Edit Profile
        function closeEditProfile() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showToast('Logged out successfully', 'success');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : 
                        type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            
            toast.innerHTML = `
                <span>${icon} ${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Handle form submission
        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newName = document.getElementById('editFullName').value;
            const newEmail = document.getElementById('editEmail').value;
            
            document.getElementById('userName').textContent = newName;
            document.getElementById('userEmail').textContent = newEmail;
            
            closeEditProfile();
            showToast('Profile updated successfully!', 'success');
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editProfileModal');
            const qrModal = document.getElementById('qrCodeModal');
            
            if (event.target === editModal) {
                closeEditProfile();
            }
            if (event.target === qrModal) {
                closeQRModal();
            }
        }

        // Treatment Functions
        function viewTreatmentDetails(treatmentType) {
            const treatments = {
                'cleaning': {
                    name: 'Dental Cleaning',
                    date: 'March 15, 2025',
                    dentist: 'Dr. Maria Santos',
                    cost: '‚Ç±2,500',
                    description: 'Professional dental cleaning and scaling to remove plaque and tartar buildup.',
                    procedures: ['Oral examination', 'Teeth scaling', 'Polishing', 'Fluoride treatment'],
                    notes: 'Regular maintenance cleaning. No complications.'
                },
                'whitening': {
                    name: 'Teeth Whitening',
                    date: 'March 10, 2025',
                    dentist: 'Dr. John Smith',
                    cost: '‚Ç±8,000',
                    description: 'Professional teeth whitening treatment for brighter smile.',
                    procedures: ['Pre-treatment assessment', 'Teeth cleaning', 'Whitening gel application', 'Post-treatment care'],
                    notes: 'Excellent results achieved. Patient satisfied with outcome.'
                },
                'extraction': {
                    name: 'Tooth Extraction',
                    date: 'March 5, 2025',
                    dentist: 'Dr. Maria Santos',
                    cost: '‚Ç±3,500',
                    description: 'Surgical extraction of damaged tooth.',
                    procedures: ['X-ray examination', 'Local anesthesia', 'Tooth extraction', 'Post-operative care'],
                    notes: 'Successful extraction. Healing progressing well.'
                },
                'checkup': {
                    name: 'Dental Checkup',
                    date: 'March 1, 2025',
                    dentist: 'Dr. John Smith',
                    cost: '‚Ç±1,500',
                    description: 'Routine dental examination and oral health assessment.',
                    procedures: ['Visual examination', 'X-rays', 'Oral health assessment', 'Treatment recommendations'],
                    notes: 'Good oral health. Regular checkups recommended.'
                }
            };

            const treatment = treatments[treatmentType];
            if (!treatment) return;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>ü¶∑ ${treatment.name} - Treatment Details</h2>
                    <div style="margin: 20px 0;">
                        <p><strong>Date:</strong> ${treatment.date}</p>
                        <p><strong>Dentist:</strong> ${treatment.dentist}</p>
                        <p><strong>Cost:</strong> ${treatment.cost}</p>
                        <p><strong>Description:</strong> ${treatment.description}</p>
                    </div>
                    <div style="margin: 20px 0;">
                        <h3>Procedures Performed:</h3>
                        <ul>
                            ${treatment.procedures.map(proc => `<li>${proc}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin: 20px 0;">
                        <h3>Notes:</h3>
                        <p>${treatment.notes}</p>
                    </div>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function bookNewTreatment() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>ü¶∑ Book New Treatment</h2>
                    <form id="treatmentForm">
                        <div class="form-group">
                            <label for="treatmentType">Treatment Type:</label>
                            <select id="treatmentType" required>
                                <option value="">Select Treatment</option>
                                <option value="cleaning">Dental Cleaning</option>
                                <option value="whitening">Teeth Whitening</option>
                                <option value="filling">Dental Filling</option>
                                <option value="extraction">Tooth Extraction</option>
                                <option value="checkup">Dental Checkup</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="preferredDate">Preferred Date:</label>
                            <input type="date" id="preferredDate" required>
                        </div>
                        <div class="form-group">
                            <label for="preferredTime">Preferred Time:</label>
                            <select id="preferredTime" required>
                                <option value="">Select Time</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="preferredDentist">Preferred Dentist:</label>
                            <select id="preferredDentist" required>
                                <option value="">Select Dentist</option>
                                <option value="Dr. Maria Santos">Dr. Maria Santos</option>
                                <option value="Dr. John Smith">Dr. John Smith</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Additional Notes:</label>
                            <textarea id="notes" rows="3" placeholder="Any specific concerns or requests..."></textarea>
                        </div>
                        <button type="submit" class="btn">üìÖ Book Treatment</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('treatmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                showToast('Treatment booking request submitted! We will contact you soon.', 'success');
                modal.remove();
            });
        }

        function downloadTreatmentHistory() {
            const csvContent = "Treatment,Date,Dentist,Cost,Status\nDental Cleaning,2025-03-15,Dr. Maria Santos,‚Ç±2,500,Completed\nTeeth Whitening,2025-03-10,Dr. John Smith,‚Ç±8,000,Completed\nTooth Extraction,2025-03-05,Dr. Maria Santos,‚Ç±3,500,Completed\nDental Checkup,2025-03-01,Dr. John Smith,‚Ç±1,500,Completed";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'treatment-history.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Treatment history downloaded!', 'success');
        }

        // Payment Functions
        function viewPaymentDetails(paymentId) {
            const payments = {
                '001': {
                    id: '001',
                    date: 'March 15, 2025',
                    amount: '‚Ç±2,500',
                    method: 'Credit Card',
                    status: 'Paid',
                    service: 'Dental Cleaning',
                    reference: 'TXN-001234567'
                },
                '002': {
                    id: '002',
                    date: 'March 10, 2025',
                    amount: '‚Ç±8,000',
                    method: 'Bank Transfer',
                    status: 'Paid',
                    service: 'Teeth Whitening',
                    reference: 'TXN-001234568'
                },
                '003': {
                    id: '003',
                    date: 'March 5, 2025',
                    amount: '‚Ç±3,500',
                    method: 'Cash',
                    status: 'Paid',
                    service: 'Tooth Extraction',
                    reference: 'TXN-001234569'
                },
                '004': {
                    id: '004',
                    date: 'March 1, 2025',
                    amount: '‚Ç±1,500',
                    method: 'Credit Card',
                    status: 'Paid',
                    service: 'Dental Checkup',
                    reference: 'TXN-001234570'
                }
            };

            const payment = payments[paymentId];
            if (!payment) return;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üí≥ Payment Receipt #${payment.id}</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Payment Details</h3>
                        <p><strong>Date:</strong> ${payment.date}</p>
                        <p><strong>Amount:</strong> ${payment.amount}</p>
                        <p><strong>Method:</strong> ${payment.method}</p>
                        <p><strong>Status:</strong> <span style="color: #27ae60;">${payment.status}</span></p>
                        <p><strong>Service:</strong> ${payment.service}</p>
                        <p><strong>Reference:</strong> ${payment.reference}</p>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn" onclick="printReceipt('${paymentId}')">üñ®Ô∏è Print Receipt</button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function makePayment() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üí≥ Make Payment</h2>
                    <form id="paymentForm">
                        <div class="form-group">
                            <label for="paymentAmount">Amount:</label>
                            <input type="number" id="paymentAmount" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method:</label>
                            <select id="paymentMethod" required>
                                <option value="">Select Method</option>
                                <option value="credit">Credit Card</option>
                                <option value="debit">Debit Card</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="gcash">GCash</option>
                                <option value="paymaya">PayMaya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentNotes">Notes:</label>
                            <textarea id="paymentNotes" rows="3" placeholder="Payment description or reference..."></textarea>
                        </div>
                        <button type="submit" class="btn">üí≥ Process Payment</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                showToast('Payment processed successfully!', 'success');
                modal.remove();
            });
        }

        function downloadPaymentHistory() {
            const csvContent = "Payment ID,Date,Amount,Method,Status,Service,Reference\n001,2025-03-15,‚Ç±2,500,Credit Card,Paid,Dental Cleaning,TXN-001234567\n002,2025-03-10,‚Ç±8,000,Bank Transfer,Paid,Teeth Whitening,TXN-001234568\n003,2025-03-05,‚Ç±3,500,Cash,Paid,Tooth Extraction,TXN-001234569\n004,2025-03-01,‚Ç±1,500,Credit Card,Paid,Dental Checkup,TXN-001234570";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'payment-history.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Payment history downloaded!', 'success');
        }

        function viewBillingInfo() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üìÑ Billing Information</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Clinic Billing Details</h3>
                        <p><strong>Clinic Name:</strong> DeLas Alas Dental Clinic</p>
                        <p><strong>Address:</strong> 123 Main Street, Manila, Philippines</p>
                        <p><strong>Phone:</strong> +63 2 1234 5678</p>
                        <p><strong>Email:</strong> billing@delasalasdental.com</p>
                        <p><strong>Tax ID:</strong> 123-456-789-000</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Payment Methods Accepted</h3>
                        <ul>
                            <li>üí≥ Credit Cards (Visa, Mastercard, Amex)</li>
                            <li>üí≥ Debit Cards</li>
                            <li>üè¶ Bank Transfer</li>
                            <li>üì± GCash</li>
                            <li>üì± PayMaya</li>
                            <li>üíµ Cash</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Billing Policies</h3>
                        <ul>
                            <li>Payment is due at the time of service</li>
                            <li>Insurance claims are processed within 5-7 business days</li>
                            <li>Late payment fees may apply after 30 days</li>
                            <li>Refunds are processed within 10-14 business days</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function printReceipt(paymentId) {
            showToast('Receipt sent to printer!', 'success');
        }

        // Settings Functions
        function changeEmail() {
            const newEmail = prompt('Enter new email address:', 'juan.delacruz@email.com');
            if (newEmail && newEmail !== 'juan.delacruz@email.com') {
                document.getElementById('userEmail').textContent = newEmail;
                showToast('Email updated successfully!', 'success');
            }
        }

        function changePhone() {
            const newPhone = prompt('Enter new phone number:', '+63 912 345 6789');
            if (newPhone && newPhone !== '+63 912 345 6789') {
                showToast('Phone number updated successfully!', 'success');
            }
        }

        function changePassword() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üîí Change Password</h2>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn">üîí Change Password</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match!', 'error');
                    return;
                }
                
                showToast('Password changed successfully!', 'success');
                modal.remove();
            });
        }

        function enable2FA() {
            showToast('Two-Factor Authentication setup coming soon!', 'info');
        }

        function saveSettings() {
            showToast('Settings saved successfully!', 'success');
        }

        function exportData() {
            const csvContent = "Data Type,Value\nFull Name,Juan Dela Cruz\nEmail,juan.delacruz@email.com\nPhone,+63 912 345 6789\nLanguage,English\nTime Zone,Asia/Manila\nTheme,Light";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'user-data-export.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    showToast('Account deletion request submitted. We will contact you within 24 hours.', 'info');
                }
            }
        }

        // Appointment Functions
        function bookNewAppointment() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üìÖ Book New Appointment</h2>
                    <form id="appointmentForm" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="form-group">
                            <label for="appointmentService">Service Type:</label>
                            <select id="appointmentService" name="appointmentService" required>
                                <option value="">Select Service</option>
                                <option value="General Checkup">General Checkup</option>
                                <option value="Teeth Cleaning">Teeth Cleaning</option>
                                <option value="Dental Filling">Dental Filling</option>
                                <option value="Tooth Extraction">Tooth Extraction</option>
                                <option value="Root Canal">Root Canal</option>
                                <option value="Dental Crown">Dental Crown</option>
                                <option value="Teeth Whitening">Teeth Whitening</option>
                                <option value="Orthodontic Consultation">Orthodontic Consultation</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentDentist">Preferred Dentist:</label>
                            <select id="appointmentDentist" required>
                                <option value="">Select Dentist</option>
                                <option value="Dr. Maria Santos">Dr. Maria Santos</option>
                                <option value="Dr. John Smith">Dr. John Smith</option>
                                <option value="Dr. Sarah Johnson">Dr. Sarah Johnson</option>
                                <option value="Dr. Michael Brown">Dr. Michael Brown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Appointment Details:</label>
                            <div class="info-box">
                                <p><i class="fas fa-info-circle"></i> <strong>Date & Time will be assigned by the dentist</strong></p>
                                <p>After booking, the dentist will review your request and assign the best available date and time for your appointment.</p>
                                <p>You will receive a notification with your appointment details and QR code.</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="appointmentNotes">Additional Notes:</label>
                            <textarea id="appointmentNotes" rows="3" placeholder="Any specific concerns or requests..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="appointmentContact">Contact Method:</label>
                            <select id="appointmentContact" required>
                                <option value="">Select Contact Method</option>
                                <option value="email">Email</option>
                                <option value="phone">Phone Call</option>
                                <option value="sms">SMS</option>
                            </select>
                        </div>
                        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #e9ecef;">
                            <div class="form-validation-status not-ready" id="formStatus">
                                <span>‚ùå</span>
                                <span>Please complete all required fields to book appointment</span>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                                <button type="submit" class="btn" id="bookAppointmentBtn" disabled>üìÖ Book Appointment</button>
                                <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                                <button type="button" class="btn btn-info" onclick="validateForm()" style="font-size: 12px;">Test Validation</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Date and time will be assigned by dentist
            
            // Generate patient calendar with availability (if needed)
            if (document.getElementById('patientCalendar')) {
                generatePatientCalendar();
            }
            
            // Set up real-time form validation
            setupFormValidation();
            
            // Wait for modal to be fully rendered, then set up validation
            setTimeout(() => {
                console.log('Setting up form validation...');
                
                // Add event listeners to form fields for real-time validation
                const formFields = ['appointmentService', 'appointmentDentist', 'appointmentContact'];
                formFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    console.log(`Field ${fieldId}:`, field);
                    if (field) {
                        field.addEventListener('change', function() {
                            console.log(`${fieldId} changed to:`, field.value);
                            validateForm();
                        });
                        field.addEventListener('input', function() {
                            console.log(`${fieldId} input to:`, field.value);
                            validateForm();
                        });
                    } else {
                        console.error(`Field ${fieldId} not found!`);
                    }
                });
                
                // Initial validation check after listeners are set up
                console.log('Running initial validation...');
                validateForm();
            }, 500);

            document.getElementById('appointmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const service = document.getElementById('appointmentService').value;
                const dentist = document.getElementById('appointmentDentist').value;
                const notes = document.getElementById('appointmentNotes').value;
                const contact = document.getElementById('appointmentContact').value;

                // Validate required fields
                if (!service) {
                    showToast('Please select a service type.', 'error');
                    return;
                }
                if (!dentist) {
                    showToast('Please select a preferred dentist.', 'error');
                    return;
                }
                if (!contact) {
                    showToast('Please select a contact method.', 'error');
                    return;
                }

                // Create appointment data for backend
                const appointmentData = {
                    serviceId: service,
                    dentistId: dentist,
                    reason: notes || '',
                    contactMethod: contact,
                    status: 'pending',
                    appointmentDate: null, // Will be set by dentist
                    appointmentTime: null, // Will be set by dentist
                    duration: 60 // Default 1 hour, dentist can change
                };

                // Show loading state
                const bookBtn = document.getElementById('bookAppointmentBtn');
                const originalText = bookBtn.innerHTML;
                bookBtn.innerHTML = '‚è≥ Booking...';
                bookBtn.disabled = true;

                // Try Firebase first, fallback to local storage
                if (window.firebase && window.firebase.firestore) {
                    saveToFirebase();
                } else {
                    saveToLocalStorage();
                }
                
                function saveToFirebase() {
                    const db = window.firebase.firestore();
                    
                    // Create booking data
                    const bookingData = {
                        patient: "Juan Dela Cruz",
                        email: "juan.delacruz@email.com",
                        phone: "+63 912 345 6789",
                        service: service,
                        dentist: dentist,
                        date: 'TBD', // To be determined by dentist
                        time: 'TBD', // To be determined by dentist
                        duration: 60, // Default 1 hour
                        notes: notes,
                        contact: contact,
                        status: 'pending',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };

                    // Save to Firebase
                    db.collection('appointments').add(bookingData)
                        .then(docRef => {
                            // Also save to local storage as backup
                            const newBooking = addBooking(bookingData);
                            
                            // Add to appointment list
                            addNewAppointment(service, dentist, 'TBD', 'TBD', 60, notes, contact);
                            
                            // Show success message
                            showToast(`üéâ Appointment request submitted! Booking ID: ${docRef.id}. The dentist will assign your date and time soon.`, 'success');
                            
                            // Close modal
                            modal.remove();
                            
                            // Reset button state
                            bookBtn.innerHTML = originalText;
                            bookBtn.disabled = false;
                        })
                        .catch(error => {
                            // Fallback to local storage
                            saveToLocalStorage();
                        });
                }
                
                function saveToLocalStorage() {
                    // Create booking data
                    const bookingData = {
                        patient: "Juan Dela Cruz",
                        email: "juan.delacruz@email.com",
                        phone: "+63 912 345 6789",
                        service: service,
                        dentist: dentist,
                        date: 'TBD', // To be determined by dentist
                        time: 'TBD', // To be determined by dentist
                        duration: 60, // Default 1 hour
                        notes: notes,
                        contact: contact,
                        status: 'pending'
                    };

                    // Add to local storage
                    const newBooking = addBooking(bookingData);
                    
                    // Add to appointment list
                    addNewAppointment(service, dentist, 'TBD', 'TBD', 60, notes, contact);
                    
                    // Show success message
                    showToast(`üéâ Appointment request submitted! Booking ID: ${newBooking.id}. The dentist will assign your date and time soon.`, 'success');
                    
                    // Close modal
                    modal.remove();
                    
                    // Reset button state
                    bookBtn.innerHTML = originalText;
                    bookBtn.disabled = false;
                }
            });
        }

        function addNewAppointment(service, dentist, date, time, duration, notes, contact) {
            const appointmentList = document.getElementById('appointmentList');
            
            // Handle TBD dates
            const formattedDate = date === 'TBD' ? 'To be assigned by dentist' : new Date(date).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const formattedTime = time === 'TBD' ? 'To be assigned by dentist' : new Date(`2000-01-01T${time}`).toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });

            // Create new appointment item
            const newAppointment = document.createElement('div');
            newAppointment.className = 'appointment-item';
            newAppointment.innerHTML = `
                <div class="appointment-info">
                    <h4>${getServiceName(service)}</h4>
                    <p>${formattedDate} at ${formattedTime}</p>
                    <p>${dentist}</p>
                    <p>Duration: ${duration} minutes</p>
                </div>
                <div class="appointment-status">
                    <span class="status pending">Pending</span>
                </div>
            `;

            // Add to the top of the list
            appointmentList.insertBefore(newAppointment, appointmentList.firstChild);
        }

        function getServiceName(service) {
            const services = {
                'cleaning': 'Dental Cleaning',
                'checkup': 'Dental Checkup',
                'filling': 'Dental Filling',
                'extraction': 'Tooth Extraction',
                'whitening': 'Teeth Whitening',
                'orthodontics': 'Orthodontics',
                'root-canal': 'Root Canal',
                'crown': 'Dental Crown'
            };
            return services[service] || service;
        }

        function rescheduleAppointment() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üìÖ Reschedule Appointment</h2>
                    <form id="rescheduleForm">
                        <div class="form-group">
                            <label for="rescheduleDate">New Date:</label>
                            <input type="date" id="rescheduleDate" required>
                        </div>
                        <div class="form-group">
                            <label for="rescheduleTime">New Time:</label>
                            <select id="rescheduleTime" required>
                                <option value="">Select Time</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="09:30">9:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="10:30">10:30 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="11:30">11:30 AM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="14:30">2:30 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="15:30">3:30 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="16:30">4:30 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rescheduleReason">Reason for Rescheduling:</label>
                            <textarea id="rescheduleReason" rows="3" placeholder="Please provide a reason for rescheduling..."></textarea>
                        </div>
                        <button type="submit" class="btn">üìÖ Reschedule Appointment</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rescheduleDate').setAttribute('min', today);

            document.getElementById('rescheduleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                showToast('Reschedule request submitted! We will contact you to confirm the new time.', 'success');
                modal.remove();
            });
        }

        function cancelAppointment() {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                if (confirm('This action cannot be undone. Are you absolutely sure?')) {
                    showToast('Appointment cancellation request submitted. We will contact you to confirm.', 'info');
                }
            }
        }

        function viewAppointmentHistory() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>üìã Appointment History</h2>
                    <div class="appointment-history">
                        <div class="history-item">
                            <div class="history-info">
                                <h4>Dental Cleaning</h4>
                                <p><strong>Date:</strong> March 15, 2025</p>
                                <p><strong>Time:</strong> 10:00 AM</p>
                                <p><strong>Dentist:</strong> Dr. Maria Santos</p>
                                <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            </div>
                        </div>
                        <div class="history-item">
                            <div class="history-info">
                                <h4>Teeth Whitening</h4>
                                <p><strong>Date:</strong> March 10, 2025</p>
                                <p><strong>Time:</strong> 2:00 PM</p>
                                <p><strong>Dentist:</strong> Dr. John Smith</p>
                                <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            </div>
                        </div>
                        <div class="history-item">
                            <div class="history-info">
                                <h4>Tooth Extraction</h4>
                                <p><strong>Date:</strong> March 5, 2025</p>
                                <p><strong>Time:</strong> 11:00 AM</p>
                                <p><strong>Dentist:</strong> Dr. Maria Santos</p>
                                <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            </div>
                        </div>
                        <div class="history-item">
                            <div class="history-info">
                                <h4>Dental Checkup</h4>
                                <p><strong>Date:</strong> March 1, 2025</p>
                                <p><strong>Time:</strong> 3:00 PM</p>
                                <p><strong>Dentist:</strong> Dr. John Smith</p>
                                <p><strong>Status:</strong> <span style="color: #27ae60;">Completed</span></p>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="downloadAppointmentHistory()">
                            üì• Download History
                        </button>
                        <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadAppointmentHistory() {
            const csvContent = "Service,Date,Time,Dentist,Status\nDental Cleaning,2025-03-15,10:00 AM,Dr. Maria Santos,Completed\nTeeth Whitening,2025-03-10,2:00 PM,Dr. John Smith,Completed\nTooth Extraction,2025-03-05,11:00 AM,Dr. Maria Santos,Completed\nDental Checkup,2025-03-01,3:00 PM,Dr. John Smith,Completed";
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'appointment-history.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Appointment history downloaded!', 'success');
        }

        // Global Booking System
        let globalBookings = JSON.parse(localStorage.getItem('dentalBookings')) || [];
        const MAX_PATIENTS_PER_DAY = 7;

        function saveBookingsToStorage() {
            localStorage.setItem('dentalBookings', JSON.stringify(globalBookings));
        }

        function getBookingsForDate(dateString) {
            return globalBookings.filter(booking => booking.date === dateString);
        }

        function addBooking(bookingData) {
            const booking = {
                id: Date.now(),
                patient: bookingData.patient,
                email: bookingData.email,
                phone: bookingData.phone,
                service: bookingData.service,
                dentist: bookingData.dentist,
                date: bookingData.date,
                time: bookingData.time,
                duration: bookingData.duration,
                notes: bookingData.notes,
                contact: bookingData.contact,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            globalBookings.push(booking);
            saveBookingsToStorage();
            return booking;
        }

        function isDateAvailable(dateString) {
            const bookingsForDate = getBookingsForDate(dateString);
            return bookingsForDate.length < MAX_PATIENTS_PER_DAY;
        }

        function getAvailableSlots(dateString) {
            const bookingsForDate = getBookingsForDate(dateString);
            return MAX_PATIENTS_PER_DAY - bookingsForDate.length;
        }

        // Patient Calendar Functions
        function generatePatientCalendar() {
            const calendarWidget = document.getElementById('patientCalendar');
            if (!calendarWidget) return;

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];

            calendarWidget.innerHTML = `
                <div class="calendar-widget-header">Sun</div>
                <div class="calendar-widget-header">Mon</div>
                <div class="calendar-widget-header">Tue</div>
                <div class="calendar-widget-header">Wed</div>
                <div class="calendar-widget-header">Thu</div>
                <div class="calendar-widget-header">Fri</div>
                <div class="calendar-widget-header">Sat</div>
            `;

            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayNumber = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const isToday = date.toDateString() === today.toDateString();
                const isPastDate = date < today;
                
                // Check real-time availability for this date
                const dateString = date.toISOString().split('T')[0];
                const isAvailable = isDateAvailable(dateString);
                const availableSlots = getAvailableSlots(dateString);
                
                const dayClass = `calendar-widget-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${isPastDate ? 'past-date' : ''}`;
                
                calendarWidget.innerHTML += `
                    <div class="${dayClass}" onclick="selectDate('${dateString}', ${isAvailable})">
                        <span>${dayNumber}</span>
                        ${isAvailable ? 
                            `<span class="availability-indicator available">‚úì</span><div class="slot-count">${availableSlots} slots</div>` : 
                            '<span class="availability-indicator unavailable">‚úó</span><div class="slot-count">Full</div>'
                        }
                    </div>
                `;
            }
        }

        function checkDateAvailability(date) {
            const dateString = date.toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            
            // Past dates are not available
            if (dateString < today) {
                return { isAvailable: false, reason: 'Past date' };
            }
            
            // Check real-time booking availability
            const isAvailable = isDateAvailable(dateString);
            const availableSlots = getAvailableSlots(dateString);
            
            if (!isAvailable) {
                return { isAvailable: false, reason: `Fully booked (${MAX_PATIENTS_PER_DAY} patients)` };
            }
            
            // Check if it's a weekend (optional - you can remove this if clinic is open weekends)
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return { isAvailable: false, reason: 'Weekend' };
            }
            
            return { isAvailable: true, reason: `${availableSlots} slots available` };
        }

        function selectDate(dateString, isAvailable) {
            if (!isAvailable) {
                const availableSlots = getAvailableSlots(dateString);
                showToast(`This date is not available for booking. ${availableSlots === 0 ? 'Fully booked (7 patients)' : `${availableSlots} slots remaining`}`, 'error');
                return;
            }
            
            // Remove previous selection
            document.querySelectorAll('.calendar-widget-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Add selection to clicked day
            event.target.closest('.calendar-widget-day').classList.add('selected');
            
            // Set the hidden date input
            document.getElementById('appointmentDate').value = dateString;
            
            // Trigger form validation
            validateForm();
            
            const availableSlots = getAvailableSlots(dateString);
            showToast(`Selected date: ${new Date(dateString).toLocaleDateString()} (${availableSlots} slots available)`, 'success');
        }

        // Function to refresh calendar when bookings change
        function refreshPatientCalendar() {
            if (document.getElementById('patientCalendar')) {
                generatePatientCalendar();
            }
        }

        // Real-time form validation
        function setupFormValidation() {
            const formFields = [
                'appointmentService',
                'appointmentDentist', 
                'appointmentContact'
            ];

            // Add event listeners to all form fields
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', validateForm);
                    field.addEventListener('input', validateForm);
                }
            });

            // Initial validation
            validateForm();
        }

        function validateForm() {
            const service = document.getElementById('appointmentService')?.value || '';
            const dentist = document.getElementById('appointmentDentist')?.value || '';
            const contact = document.getElementById('appointmentContact')?.value || '';

            // Debug logging
            console.log('=== VALIDATION DEBUG ===');
            console.log('Service element:', document.getElementById('appointmentService'));
            console.log('Service value:', service);
            console.log('Dentist value:', dentist);
            console.log('Contact value:', contact);
            console.log('Is complete:', service && dentist && contact);

            const isFormComplete = service && dentist && contact;
            
            const bookBtn = document.getElementById('bookAppointmentBtn');
            const formStatus = document.getElementById('formStatus');
            
            if (isFormComplete) {
                // Enable button and make it green
                if (bookBtn) {
                    bookBtn.disabled = false;
                    bookBtn.classList.add('btn-ready');
                    bookBtn.classList.remove('btn-secondary');
                    bookBtn.style.backgroundColor = '#28a745';
                    bookBtn.style.color = 'white';
                }
                
                // Update status message
                if (formStatus) {
                    formStatus.className = 'form-validation-status ready';
                    formStatus.innerHTML = '<span>‚úÖ</span><span>All fields completed! Ready to book appointment</span>';
                }
            } else {
                // Disable button
                if (bookBtn) {
                    bookBtn.disabled = true;
                    bookBtn.classList.remove('btn-ready');
                    bookBtn.style.backgroundColor = '#6c757d';
                    bookBtn.style.color = 'white';
                }
                
                // Update status message
                if (formStatus) {
                    formStatus.className = 'form-validation-status not-ready';
                    
                    // Show specific missing fields
                    const missingFields = [];
                    if (!service) missingFields.push('Service Type');
                    if (!dentist) missingFields.push('Preferred Dentist');
                    if (!contact) missingFields.push('Contact Method');
                    
                    formStatus.innerHTML = `<span>‚ùå</span><span>Missing: ${missingFields.join(', ')}</span>`;
                }
            }
        }


        // Listen for storage changes to sync across tabs
        window.addEventListener('storage', function(e) {
            if (e.key === 'dentalBookings') {
                globalBookings = JSON.parse(e.newValue) || [];
                refreshPatientCalendar();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Generate QR code immediately using fallback method
            showFallbackQRCode();
            showToast('Dashboard loaded successfully!', 'success');
            
            // Load appointments from backend
            loadAppointmentsFromBackend();
            
            // Try to load real QR code library after a delay
            setTimeout(function() {
                if (typeof QRCode !== 'undefined') {
                    generateQRCode();
                    showToast('QR Code updated with real QR code!', 'success');
                } else {
                    console.log('QRCode library not available, using fallback');
                }
            }, 2000);
        });

        // Load appointments from backend API
        function loadAppointmentsFromBackend() {
            const appointmentList = document.getElementById('appointmentList');
            if (!appointmentList) return;
            
            // Clear existing appointments
            appointmentList.innerHTML = '';
            
            // Try Firebase first, fallback to local storage
            if (window.firebase && window.firebase.firestore) {
                loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
            
            function loadFromFirebase() {
                const db = window.firebase.firestore();
                
                db.collection('appointments')
                    .orderBy('createdAt', 'desc')
                    .get()
                    .then(querySnapshot => {
                        const appointments = [];
                        
                        querySnapshot.forEach(doc => {
                            const appointment = doc.data();
                            appointments.push({
                                id: doc.id,
                                ...appointment
                            });
                        });
                        
                        displayAppointments(appointments);
                    })
                    .catch(error => {
                        console.error('Error loading appointments from Firebase:', error);
                        loadFromLocalStorage();
                    });
            }
            
            function loadFromLocalStorage() {
                const globalBookings = JSON.parse(localStorage.getItem('dentalBookings')) || [];
                
                if (globalBookings.length === 0) {
                    appointmentList.innerHTML = `
                        <div class="no-appointments">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>No appointments yet</h3>
                            <p>Book your first appointment to get started!</p>
                            <button class="btn btn-primary" onclick="bookNewAppointment()">Book Appointment</button>
                        </div>
                    `;
                    return;
                }
                
                displayAppointments(globalBookings);
            }
            
            function displayAppointments(appointments) {
                appointments.forEach(booking => {
                    const appointmentDate = new Date(booking.date);
                    const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    const timeObj = new Date(`2000-01-01T${booking.time}`);
                    const formattedTime = timeObj.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });

                    const statusClass = booking.status === 'pending' ? 'pending' : 
                                      booking.status === 'confirmed' ? 'approved' : 
                                      booking.status === 'completed' ? 'completed' : 'cancelled';

                    const appointmentElement = document.createElement('div');
                    appointmentElement.className = `appointment-item ${statusClass}`;
                    appointmentElement.innerHTML = `
                        <div class="appointment-header">
                            <h4>${booking.service}</h4>
                            <span class="appointment-status">${booking.status}</span>
                        </div>
                        <div class="appointment-details">
                            <p><strong>Dentist:</strong> ${booking.dentist}</p>
                            <p><strong>Date:</strong> ${formattedDate}</p>
                            <p><strong>Time:</strong> ${formattedTime}</p>
                            <p><strong>Duration:</strong> ${booking.duration} minutes</p>
                            ${booking.notes ? `<p><strong>Notes:</strong> ${booking.notes}</p>` : ''}
                        </div>
                        <div class="appointment-actions">
                            ${booking.status === 'pending' ? 
                                '<button class="btn btn-secondary" onclick="cancelAppointment(' + booking.id + ')">Cancel</button>' : 
                                ''
                            }
                        </div>
                    `;
                    
                    appointmentList.appendChild(appointmentElement);
                });
            }
        }

        // Cancel appointment function
        function cancelAppointment(appointmentId) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                if (window.apiClient) {
                    window.apiClient.cancelAppointment(appointmentId)
                        .then(response => {
                            if (response.success) {
                                showToast('Appointment cancelled successfully', 'success');
                                loadAppointmentsFromBackend(); // Reload appointments
                            } else {
                                throw new Error(response.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error cancelling appointment:', error);
                            showToast('Failed to cancel appointment: ' + error.message, 'error');
                        });
                }
            }
        }

        // ========================================
        // PATIENT DASHBOARD FUNCTIONS
        // ========================================

        // Navigation Functions
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Highlight active nav item
            const activeNav = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            // Load section-specific data
            loadSectionData(sectionName);
        }

        function loadSectionData(sectionName) {
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'appointments':
                    loadAppointmentsFromBackend();
                    break;
                case 'treatments':
                    loadTreatments();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'qr-code':
                    loadQRCode();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Dashboard Functions
        function loadDashboardData() {
            // Load dashboard statistics
            const stats = {
                totalAppointments: 8,
                treatmentsDone: 12,
                totalPayments: '‚Ç±15,500',
                medicalRecords: 5
            };
            
            // Update stat cards
            document.querySelectorAll('.stat-number').forEach((stat, index) => {
                const values = Object.values(stats);
                if (values[index]) {
                    stat.textContent = values[index];
                }
            });
        }

        // Treatments Functions
        function loadTreatments() {
            const treatmentsContainer = document.getElementById('treatmentsList');
            if (!treatmentsContainer) return;
            
            const treatments = [
                {
                    id: 1,
                    name: 'Dental Cleaning',
                    date: 'March 10, 2025',
                    dentist: 'Dr. Maria Santos',
                    status: 'Completed',
                    cost: '‚Ç±2,500'
                },
                {
                    id: 2,
                    name: 'Tooth Extraction',
                    date: 'March 5, 2025',
                    dentist: 'Dr. Maria Santos',
                    status: 'Completed',
                    cost: '‚Ç±3,500'
                },
                {
                    id: 3,
                    name: 'Dental Checkup',
                    date: 'March 1, 2025',
                    dentist: 'Dr. John Smith',
                    status: 'Completed',
                    cost: '‚Ç±1,500'
                }
            ];
            
            treatmentsContainer.innerHTML = treatments.map(treatment => `
                <div class="treatment-card">
                    <h4>ü¶∑ ${treatment.name}</h4>
                    <p><strong>Date:</strong> ${treatment.date}</p>
                    <p><strong>Dentist:</strong> ${treatment.dentist}</p>
                    <p><strong>Status:</strong> <span style="color: #27ae60;">${treatment.status}</span></p>
                    <p><strong>Cost:</strong> ${treatment.cost}</p>
                    <button class="btn btn-secondary" onclick="viewTreatmentDetails(${treatment.id})">
                        üìã View Details
                    </button>
                </div>
            `).join('');
        }

        function viewTreatmentDetails(treatmentId) {
            const treatment = {
                1: {
                    name: 'Dental Cleaning',
                    date: 'March 10, 2025',
                    dentist: 'Dr. Maria Santos',
                    status: 'Completed',
                    cost: '‚Ç±2,500',
                    description: 'Professional dental cleaning and scaling',
                    notes: 'Patient had minimal plaque buildup. Recommended regular checkups every 6 months.',
                    procedures: ['Scaling', 'Polishing', 'Fluoride Treatment']
                }
            };
            
            const treatmentData = treatment[treatmentId];
            if (treatmentData) {
                showModal('Treatment Details', `
                    <div class="treatment-details">
                        <h3>${treatmentData.name}</h3>
                        <div class="detail-row">
                            <strong>Date:</strong> ${treatmentData.date}
                        </div>
                        <div class="detail-row">
                            <strong>Dentist:</strong> ${treatmentData.dentist}
                        </div>
                        <div class="detail-row">
                            <strong>Status:</strong> <span style="color: #27ae60;">${treatmentData.status}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Cost:</strong> ${treatmentData.cost}
                        </div>
                        <div class="detail-row">
                            <strong>Description:</strong> ${treatmentData.description}
                        </div>
                        <div class="detail-row">
                            <strong>Notes:</strong> ${treatmentData.notes}
                        </div>
                        <div class="detail-row">
                            <strong>Procedures:</strong>
                            <ul>
                                ${treatmentData.procedures.map(proc => `<li>${proc}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `);
            }
        }

        function bookNewTreatment() {
            showModal('Book New Treatment', `
                <form id="treatmentForm">
                    <div class="form-group">
                        <label for="treatmentType">Treatment Type:</label>
                        <select id="treatmentType" required>
                            <option value="">Select Treatment</option>
                            <option value="cleaning">Dental Cleaning</option>
                            <option value="checkup">Dental Checkup</option>
                            <option value="filling">Dental Filling</option>
                            <option value="extraction">Tooth Extraction</option>
                            <option value="whitening">Teeth Whitening</option>
                            <option value="orthodontics">Orthodontics</option>
                            <option value="root-canal">Root Canal</option>
                            <option value="crown">Dental Crown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="treatmentDentist">Preferred Dentist:</label>
                        <select id="treatmentDentist" required>
                            <option value="">Select Dentist</option>
                            <option value="Dr. Maria Santos">Dr. Maria Santos</option>
                            <option value="Dr. John Smith">Dr. John Smith</option>
                            <option value="Dr. Sarah Johnson">Dr. Sarah Johnson</option>
                            <option value="Dr. Michael Brown">Dr. Michael Brown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="treatmentNotes">Additional Notes:</label>
                        <textarea id="treatmentNotes" rows="3" placeholder="Describe your concerns or specific requirements..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="treatmentUrgency">Urgency Level:</label>
                        <select id="treatmentUrgency">
                            <option value="routine">Routine</option>
                            <option value="urgent">Urgent</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="submit" class="btn">üìÖ Book Treatment</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </div>
                </form>
            `);
            
            // Add form submission handler
            document.getElementById('treatmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const treatmentType = document.getElementById('treatmentType').value;
                const dentist = document.getElementById('treatmentDentist').value;
                const notes = document.getElementById('treatmentNotes').value;
                const urgency = document.getElementById('treatmentUrgency').value;
                
                if (treatmentType && dentist) {
                    showToast(`üéâ Treatment request submitted! The dentist will review and schedule your ${treatmentType} appointment.`, 'success');
                    this.parentElement.parentElement.remove();
                    loadTreatments(); // Refresh treatments list
                } else {
                    showToast('Please fill in all required fields.', 'error');
                }
            });
        }

        function downloadTreatmentHistory() {
            showToast('üì• Downloading treatment history...', 'info');
            // In a real app, this would generate and download a PDF
            setTimeout(() => {
                showToast('‚úÖ Treatment history downloaded successfully!', 'success');
            }, 2000);
        }

        // Payments Functions
        function loadPayments() {
            const paymentsContainer = document.getElementById('paymentsList');
            if (!paymentsContainer) return;
            
            const payments = [
                {
                    id: 1,
                    date: 'March 10, 2025',
                    description: 'Dental Cleaning',
                    amount: '‚Ç±2,500',
                    status: 'Paid',
                    method: 'Credit Card'
                },
                {
                    id: 2,
                    date: 'March 5, 2025',
                    description: 'Tooth Extraction',
                    amount: '‚Ç±3,500',
                    status: 'Paid',
                    method: 'Cash'
                },
                {
                    id: 3,
                    date: 'March 1, 2025',
                    description: 'Dental Checkup',
                    amount: '‚Ç±1,500',
                    status: 'Paid',
                    method: 'Bank Transfer'
                }
            ];
            
            paymentsContainer.innerHTML = payments.map(payment => `
                <div class="payment-card">
                    <div class="payment-header">
                        <h4>${payment.description}</h4>
                        <span class="payment-status ${payment.status.toLowerCase()}">${payment.status}</span>
                    </div>
                    <div class="payment-details">
                        <p><strong>Date:</strong> ${payment.date}</p>
                        <p><strong>Amount:</strong> ${payment.amount}</p>
                        <p><strong>Method:</strong> ${payment.method}</p>
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-sm" onclick="viewPaymentDetails(${payment.id})">View Details</button>
                        <button class="btn btn-sm btn-secondary" onclick="downloadReceipt(${payment.id})">Download Receipt</button>
                    </div>
                </div>
            `).join('');
        }

        function viewPaymentDetails(paymentId) {
            const payment = {
                1: {
                    description: 'Dental Cleaning',
                    date: 'March 10, 2025',
                    amount: '‚Ç±2,500',
                    status: 'Paid',
                    method: 'Credit Card',
                    transactionId: 'TXN-2025-001',
                    receiptNumber: 'RCP-2025-001'
                }
            };
            
            const paymentData = payment[paymentId];
            if (paymentData) {
                showModal('Payment Details', `
                    <div class="payment-details">
                        <h3>${paymentData.description}</h3>
                        <div class="detail-row">
                            <strong>Date:</strong> ${paymentData.date}
                        </div>
                        <div class="detail-row">
                            <strong>Amount:</strong> ${paymentData.amount}
                        </div>
                        <div class="detail-row">
                            <strong>Status:</strong> <span style="color: #27ae60;">${paymentData.status}</span>
                        </div>
                        <div class="detail-row">
                            <strong>Payment Method:</strong> ${paymentData.method}
                        </div>
                        <div class="detail-row">
                            <strong>Transaction ID:</strong> ${paymentData.transactionId}
                        </div>
                        <div class="detail-row">
                            <strong>Receipt Number:</strong> ${paymentData.receiptNumber}
                        </div>
                    </div>
                `);
            }
        }

        function makePayment() {
            showModal('Make Payment', `
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="paymentAmount">Amount:</label>
                        <input type="number" id="paymentAmount" placeholder="Enter amount" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method:</label>
                        <select id="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="credit-card">Credit Card</option>
                            <option value="debit-card">Debit Card</option>
                            <option value="bank-transfer">Bank Transfer</option>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="paymaya">PayMaya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentDescription">Description:</label>
                        <input type="text" id="paymentDescription" placeholder="Payment description" required>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="submit" class="btn">üí≥ Process Payment</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </div>
                </form>
            `);
            
            // Add form submission handler
            document.getElementById('paymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const amount = document.getElementById('paymentAmount').value;
                const method = document.getElementById('paymentMethod').value;
                const description = document.getElementById('paymentDescription').value;
                
                if (amount && method && description) {
                    showToast(`üí≥ Payment of ‚Ç±${amount} processed successfully!`, 'success');
                    this.parentElement.parentElement.remove();
                    loadPayments(); // Refresh payments list
                } else {
                    showToast('Please fill in all required fields.', 'error');
                }
            });
        }

        function downloadReceipt(paymentId) {
            showToast(`üì• Downloading receipt for payment ${paymentId}...`, 'info');
            setTimeout(() => {
                showToast('‚úÖ Receipt downloaded successfully!', 'success');
            }, 2000);
        }

        function downloadPaymentHistory() {
            showToast('üì• Downloading payment history...', 'info');
            setTimeout(() => {
                showToast('‚úÖ Payment history downloaded successfully!', 'success');
            }, 2000);
        }

        function viewBillingInfo() {
            showModal('Billing Information', `
                <div class="billing-info">
                    <h3>Delas Alas Dental Clinic</h3>
                    <div class="billing-details">
                        <p><strong>Address:</strong> 123 Main Street, Manila, Philippines</p>
                        <p><strong>Phone:</strong> (02) 1234-5678</p>
                        <p><strong>Email:</strong> billing@delasalasdental.com</p>
                        <p><strong>Tax ID:</strong> 123-456-789-000</p>
                        <p><strong>Business Hours:</strong> Monday - Friday, 8:00 AM - 6:00 PM</p>
                    </div>
                    <div class="payment-methods">
                        <h4>Accepted Payment Methods:</h4>
                        <ul>
                            <li>Credit/Debit Cards (Visa, Mastercard, American Express)</li>
                            <li>Bank Transfer (BDO, BPI, Metrobank)</li>
                            <li>Digital Wallets (GCash, PayMaya)</li>
                            <li>Cash</li>
                        </ul>
                    </div>
                </div>
            `);
        }

        // QR Code Functions
        function loadQRCode() {
            const qrContainer = document.getElementById('qrCodeContainer');
            if (!qrContainer) return;
            
            // Generate QR code for patient
            const patientId = 'PAT-001';
            const qrData = `Patient: Juan Dela Cruz\nID: ${patientId}\nClinic: Delas Alas Dental Clinic`;
            
            qrContainer.innerHTML = `
                <div class="qr-code-section">
                    <h3>My QR Code</h3>
                    <div class="qr-code-display">
                        <div id="qrCode" class="qr-code"></div>
                        <p>Scan this QR code at the clinic for quick check-in</p>
                    </div>
                    <div class="qr-actions">
                        <button class="btn" onclick="generateNewQR()">üîÑ Generate New QR</button>
                        <button class="btn btn-secondary" onclick="downloadQR()">üì• Download QR</button>
                        <button class="btn btn-secondary" onclick="printQR()">üñ®Ô∏è Print QR</button>
                    </div>
                </div>
            `;
            
            // Generate QR code
            generateQRCode(qrData);
        }

        function generateQRCode(data) {
            const qrElement = document.getElementById('qrCode');
            if (qrElement) {
                // Simple QR code representation (in real app, use a QR library)
                qrElement.innerHTML = `
                    <div style="width: 200px; height: 200px; border: 2px solid #333; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr);">
                        ${Array(100).fill(0).map(() => `<div style="background: ${Math.random() > 0.5 ? '#000' : '#fff'};"></div>`).join('')}
                    </div>
                `;
            }
        }

        function generateNewQR() {
            showToast('üîÑ Generating new QR code...', 'info');
            setTimeout(() => {
                loadQRCode();
                showToast('‚úÖ New QR code generated!', 'success');
            }, 1000);
        }

        function downloadQR() {
            showToast('üì• Downloading QR code...', 'info');
            setTimeout(() => {
                showToast('‚úÖ QR code downloaded successfully!', 'success');
            }, 2000);
        }

        function printQR() {
            showToast('üñ®Ô∏è Printing QR code...', 'info');
            setTimeout(() => {
                showToast('‚úÖ QR code sent to printer!', 'success');
            }, 1000);
        }

        // Settings Functions
        function loadSettings() {
            const settingsContainer = document.getElementById('settingsContainer');
            if (!settingsContainer) return;
            
            settingsContainer.innerHTML = `
                <div class="settings-section">
                    <h3>Profile Settings</h3>
                    <div class="settings-item">
                        <label>Full Name:</label>
                        <input type="text" id="userFullName" value="Juan Dela Cruz">
                        <button class="btn btn-sm" onclick="updateProfile()">Update</button>
                    </div>
                    <div class="settings-item">
                        <label>Email:</label>
                        <input type="email" id="userEmail" value="juan.delacruz@email.com">
                        <button class="btn btn-sm" onclick="updateProfile()">Update</button>
                    </div>
                    <div class="settings-item">
                        <label>Phone:</label>
                        <input type="tel" id="userPhone" value="+63 912 345 6789">
                        <button class="btn btn-sm" onclick="updateProfile()">Update</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Notification Settings</h3>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="emailNotifications" checked> Email Notifications
                        </label>
                    </div>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="smsNotifications" checked> SMS Notifications
                        </label>
                    </div>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="appointmentReminders" checked> Appointment Reminders
                        </label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Privacy Settings</h3>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="shareData" checked> Share data for better service
                        </label>
                    </div>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="marketingEmails"> Receive marketing emails
                        </label>
                    </div>
                </div>
                
                <div class="settings-actions">
                    <button class="btn" onclick="saveSettings()">üíæ Save Settings</button>
                    <button class="btn btn-secondary" onclick="resetSettings()">üîÑ Reset to Default</button>
                    <button class="btn btn-danger" onclick="deleteAccount()">üóëÔ∏è Delete Account</button>
                </div>
            `;
        }

        function updateProfile() {
            const fullName = document.getElementById('userFullName').value;
            const email = document.getElementById('userEmail').value;
            const phone = document.getElementById('userPhone').value;
            
            if (fullName && email && phone) {
                showToast('‚úÖ Profile updated successfully!', 'success');
                // Update user info in sidebar
                document.getElementById('userName').textContent = fullName;
                document.getElementById('userEmail').textContent = email;
            } else {
                showToast('Please fill in all fields.', 'error');
            }
        }

        function saveSettings() {
            showToast('üíæ Settings saved successfully!', 'success');
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                showToast('üîÑ Settings reset to default!', 'success');
                loadSettings();
            }
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    showToast('üóëÔ∏è Account deletion requested. You will be logged out.', 'info');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            }
        }

        // Profile Functions
        function openEditProfile() {
            showModal('Edit Profile', `
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileName">Full Name:</label>
                        <input type="text" id="profileName" value="Juan Dela Cruz" required>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email:</label>
                        <input type="email" id="profileEmail" value="juan.delacruz@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Phone:</label>
                        <input type="tel" id="profilePhone" value="+63 912 345 6789" required>
                    </div>
                    <div class="form-group">
                        <label for="profileAddress">Address:</label>
                        <textarea id="profileAddress" rows="3" placeholder="Enter your address">123 Main Street, Manila, Philippines</textarea>
                    </div>
                    <div class="form-group">
                        <label for="profileBirthdate">Birth Date:</label>
                        <input type="date" id="profileBirthdate" value="1990-01-15">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="submit" class="btn">üíæ Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">Cancel</button>
                    </div>
                </form>
            `);
            
            // Add form submission handler
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('profileName').value;
                const email = document.getElementById('profileEmail').value;
                const phone = document.getElementById('profilePhone').value;
                const address = document.getElementById('profileAddress').value;
                const birthdate = document.getElementById('profileBirthdate').value;
                
                if (name && email && phone) {
                    // Update user info in sidebar
                    document.getElementById('userName').textContent = name;
                    document.getElementById('userEmail').textContent = email;
                    
                    showToast('‚úÖ Profile updated successfully!', 'success');
                    this.parentElement.parentElement.remove();
                } else {
                    showToast('Please fill in all required fields.', 'error');
                }
            });
        }

        // Utility Functions
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>${title}</h2>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showToast('üëã Logging out...', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- API Client -->
    <script src="assets/js/api-client.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="assets/js/firebase-config.js"></script>
</body>
</html>
